# v0.2: Acquittements fonctionnels

## Documentation
- Le DST v0.1.1 contient des informations plus détaillées sur les versions et messages
- La [documentation de Docker](https://docs.docker.com/get-started/overview/)
- Les [tutoriels de RabbitMQ](https://www.rabbitmq.com/getstarted.html) dans le langage de votre choix

## Objectifs
- [ ] Faire évoluer le `Consumer` pour envoyer des acquittements fonctionnels
  - Après le bon traitement de messages de `*.in.message`
  - Publication sur l'exchange `hubsante` en mode `topic` (voir [tutoriel 5](https://www.rabbitmq.com/tutorials/tutorial-five-python.html))
  - *Routing Key* de la forme `$CLIENT_ID.out.ack`
- [ ] Faire évoluer le `Consumer` pour recevoir les acquittements fonctionnels
  - Consommer d'une queue nommée sous la forme `$CLIENT_ID.in.ack`
  - Acquitter techniquement les messages une fois que le Hub Santé ne doit plus tenter de les redélivrer en cas de problème
  - Ne pas envoyer un acquittement fonctionnel pour ces messages

## Messages
Le format des messages de la v0.2 est basé sur de simples JSON et illustré dans [Message.java](../src/main/java/com/hubsante/Message.java)
```json
{
  "to": "Self-Sante",
  "senderId": "Self-Sante",
  "distributionId": "Self-Sante_messageId",
  "content": "Contenu"
}
```

## Implémentation Java
- [x] [`Consumer.java`](../src/main/java/com/hubsante/Consumer.java) envoyant des acquittements fonctionnels après le traitement des messages reçus
  - in.message : `CLIENT_ID=Self-Sante; gradle -Pmain=com.hubsante.Consumer run --args "$CLIENT_ID.in.message"`
- [x] [`Consumer.java`](../src/main/java/com/hubsante/Consumer.java) réceptionnant les acquittements fonctionnels
  - in.ack : `CLIENT_ID=Self-Sante; gradle -Pmain=com.hubsante.Consumer run --args "$CLIENT_ID.in.ack"`

## Test
```
# Shell 1: run Hub Santé locally
docker compose up

# Shell 2: run *.in.message Consumer
CLIENT_ID=Self-Sante; gradle -Pmain=com.hubsante.Consumer run --args "$CLIENT_ID.in.message"

# Shell 3: run *.in.ack Consumer
CLIENT_ID=Self-Sante; gradle -Pmain=com.hubsante.Consumer run --args "$CLIENT_ID.in.ack"

# Shell 4: run Producer each time you want to send a message
CLIENT_ID=Self-Sante; gradle -Pmain=com.hubsante.Producer run --args "$CLIENT_ID.out.message {'to': '$CLIENT_ID', 'senderId': '$CLIENT_ID', 'distributionId': '${CLIENT_ID}_messageId123', 'content': 'test'}"

# Test : confirm messages are read by message Consumer + sends Ack back to Hub + read by ack Consumer & all correctly technically ack-ed (check through RAbbitMQ UI) 
```